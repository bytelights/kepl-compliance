<div class="dashboard-wrapper">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading" class="dashboard-container">
    
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1>Dashboard</h1>
        <p class="page-subtitle">Welcome back, {{ user?.name }}</p>
      </div>
    </div>

    <!-- Date Filter Section -->
    <mat-card class="filter-card">
      <mat-card-content>
        <form [formGroup]="dateFilterForm" class="date-filter-form">
          <div class="filter-row">
            <mat-form-field appearance="outline" class="filter-type-field">
              <mat-label>Time Period</mat-label>
              <mat-select formControlName="filterType" (selectionChange)="onFilterTypeChange()">
                <mat-option value="all">All Time</mat-option>
                <mat-option value="last30days">Last 30 Days</mat-option>
                <mat-option value="dateRange">Custom Date Range</mat-option>
                <mat-option value="financialYear">Financial Year</mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Date Range Fields -->
            <ng-container *ngIf="dateFilterForm.get('filterType')?.value === 'dateRange'">
              <mat-form-field appearance="outline">
                <mat-label>Start Date</mat-label>
                <input matInput [matDatepicker]="startPicker" formControlName="startDate">
                <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>End Date</mat-label>
                <input matInput [matDatepicker]="endPicker" formControlName="endDate">
                <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                <mat-datepicker #endPicker></mat-datepicker>
              </mat-form-field>
            </ng-container>

            <!-- Financial Year Field -->
            <mat-form-field 
              appearance="outline" 
              *ngIf="dateFilterForm.get('filterType')?.value === 'financialYear'"
              class="fy-field">
              <mat-label>Select Financial Year</mat-label>
              <mat-select formControlName="financialYear">
                <mat-option *ngFor="let fy of financialYearOptions" [value]="fy.value">
                  {{ fy.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Filter Actions -->
            <div class="filter-actions">
              <button 
                mat-raised-button 
                color="primary" 
                (click)="applyDateFilter()"
                [disabled]="dateFilterForm.get('filterType')?.value === 'dateRange' && (!dateFilterForm.get('startDate')?.value || !dateFilterForm.get('endDate')?.value)">
                <mat-icon>filter_list</mat-icon>
                Apply Filter
              </button>
              <button mat-button (click)="resetDateFilter()">
                <mat-icon>clear</mat-icon>
                Reset
              </button>
            </div>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Task Owner Dashboard -->
    <div *ngIf="isTaskOwner()" class="dashboard-content">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-info">
                <div class="stat-label">Pending Tasks</div>
                <div class="stat-value">{{ taskOwnerData?.pendingCount || 0 }}</div>
              </div>
              <div class="stat-icon pending">
                <mat-icon>assignment</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-info">
                <div class="stat-label">Due This Week</div>
                <div class="stat-value">{{ taskOwnerData?.dueThisWeekCount || 0 }}</div>
              </div>
              <div class="stat-icon warning">
                <mat-icon>schedule</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-info">
                <div class="stat-label">Overdue</div>
                <div class="stat-value">{{ taskOwnerData?.overdueCount || 0 }}</div>
              </div>
              <div class="stat-icon danger">
                <mat-icon>warning</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Task Status Chart -->
      <mat-card class="content-card chart-card">
        <mat-card-header>
          <mat-card-title>Task Distribution</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container doughnut-chart">
            <canvas baseChart
              [type]="doughnutChartType"
              [data]="taskOwnerChartData"
              [options]="doughnutChartOptions">
            </canvas>
            <div class="chart-center-label">
              <div class="center-number">{{ (taskOwnerData?.pendingCount || 0) + (taskOwnerData?.overdueCount || 0) }}</div>
              <div class="center-text">Total Tasks</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Recent Tasks Table -->
      <mat-card class="content-card">
        <mat-card-header>
          <mat-card-title>Recent Tasks</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="!taskOwnerData?.recentTasks?.length" class="empty-state">
            <mat-icon>check_circle</mat-icon>
            <p>No pending tasks</p>
          </div>

          <div *ngIf="taskOwnerData?.recentTasks?.length" class="table-container">
            <table mat-table [dataSource]="taskOwnerData?.recentTasks || []">
              <ng-container matColumnDef="complianceId">
                <th mat-header-cell *matHeaderCellDef>ID</th>
                <td mat-cell *matCellDef="let task">{{ task.complianceId }}</td>
              </ng-container>

              <ng-container matColumnDef="title">
                <th mat-header-cell *matHeaderCellDef>Title</th>
                <td mat-cell *matCellDef="let task">{{ task.title }}</td>
              </ng-container>

              <ng-container matColumnDef="entity">
                <th mat-header-cell *matHeaderCellDef>Entity</th>
                <td mat-cell *matCellDef="let task">{{ task.entity?.name }}</td>
              </ng-container>

              <ng-container matColumnDef="dueDate">
                <th mat-header-cell *matHeaderCellDef>Due Date</th>
                <td mat-cell *matCellDef="let task">
                  <span [class.overdue]="isOverdue(task.dueDate)">
                    {{ task.dueDate | date: 'MMM d, y' }}
                  </span>
                </td>
              </ng-container>

              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let task">
                  <span class="status-badge" [class]="'status-' + task.status">{{ task.status }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let task">
                  <button mat-button color="primary" [routerLink]="['/tasks', task.id]">
                    View
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="taskColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: taskColumns"></tr>
            </table>
          </div>

          <div class="card-actions" *ngIf="taskOwnerData?.recentTasks?.length">
            <button mat-raised-button color="primary" routerLink="/tasks">
              View All Tasks
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Reviewer/Admin Dashboard -->
    <div *ngIf="isReviewer() || isAdmin()" class="dashboard-content">
      <!-- Admin Stats -->
      <div *ngIf="isAdmin() && adminData" class="stats-grid">
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-info">
                <div class="stat-label">Total Tasks</div>
                <div class="stat-value">{{ adminData.totalTasks }}</div>
              </div>
              <div class="stat-icon primary">
                <mat-icon>assignment</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-info">
                <div class="stat-label">Pending</div>
                <div class="stat-value">{{ adminData.pendingTasks }}</div>
              </div>
              <div class="stat-icon pending">
                <mat-icon>pending_actions</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-info">
                <div class="stat-label">Completed</div>
                <div class="stat-value">{{ adminData.completedTasks }}</div>
              </div>
              <div class="stat-icon success">
                <mat-icon>check_circle</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-info">
                <div class="stat-label">Skipped</div>
                <div class="stat-value">{{ adminData.skippedTasks }}</div>
              </div>
              <div class="stat-icon skipped">
                <mat-icon>block</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-info">
                <div class="stat-label">Overdue</div>
                <div class="stat-value">{{ adminData.overdueTasks }}</div>
              </div>
              <div class="stat-icon danger">
                <mat-icon>warning</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Quick Actions - Redesigned -->
      <mat-card class="content-card quick-actions-card">
        <mat-card-header>
          <mat-card-title>Quick Actions</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="quick-actions-grid">
            <button mat-flat-button class="quick-action-btn" routerLink="/tasks">
              <mat-icon>view_list</mat-icon>
              <span>All Tasks</span>
            </button>
            <button mat-flat-button class="quick-action-btn" routerLink="/tasks" [queryParams]="{status: 'PENDING'}">
              <mat-icon>pending_actions</mat-icon>
              <span>Pending</span>
            </button>
            <button *ngIf="isAdmin()" mat-flat-button class="quick-action-btn" routerLink="/admin/import">
              <mat-icon>upload_file</mat-icon>
              <span>Import CSV</span>
            </button>
            <button *ngIf="isAdmin()" mat-flat-button class="quick-action-btn" routerLink="/admin/users">
              <mat-icon>people</mat-icon>
              <span>Users</span>
            </button>
            <button *ngIf="isAdmin()" mat-flat-button class="quick-action-btn" routerLink="/admin/master-data">
              <mat-icon>storage</mat-icon>
              <span>Master Data</span>
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Admin Charts - Moved to Bottom with More Visualizations -->
      <div *ngIf="isAdmin() && adminData">
        <h2 class="section-title">Analytics & Insights</h2>
        <div class="charts-row">
          <mat-card class="content-card chart-card">
            <mat-card-header>
              <mat-card-title>Task Status Distribution</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container doughnut-chart">
                <canvas baseChart
                  [type]="doughnutChartType"
                  [data]="adminStatusChartData"
                  [options]="doughnutChartOptions">
                </canvas>
                <div class="chart-center-label">
                  <div class="center-number">{{ adminData.totalTasks }}</div>
                  <div class="center-text">Total Tasks</div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="content-card chart-card">
            <mat-card-header>
              <mat-card-title>Task Completion Trends</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas baseChart
                  [type]="lineChartType"
                  [data]="adminTrendsChartData"
                  [options]="lineChartOptions">
                </canvas>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <div class="charts-row">
          <mat-card class="content-card chart-card">
            <mat-card-header>
              <mat-card-title>Tasks by Department</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas baseChart
                  [type]="barChartType"
                  [data]="adminDepartmentChartData"
                  [options]="barChartOptions">
                </canvas>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="content-card chart-card">
            <mat-card-header>
              <mat-card-title>Tasks by Assigned Person</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas baseChart
                  [type]="barChartType"
                  [data]="adminOwnerChartData"
                  [options]="barChartOptions">
                </canvas>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <div class="charts-row">
          <mat-card class="content-card chart-card">
            <mat-card-header>
              <mat-card-title>Recent CSV Imports</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="import-list" *ngIf="adminData.recentImports.length; else noImports">
                <div class="import-item" *ngFor="let import of adminData.recentImports">
                  <div class="import-info">
                    <mat-icon>upload_file</mat-icon>
                    <div>
                      <div class="import-name">{{ import.fileName }}</div>
                      <div class="import-meta">{{ import.totalRows }} rows • {{ import.createdAt | date:'short' }}</div>
                    </div>
                  </div>
                  <span class="import-status" [ngClass]="'status-' + import.status">{{ import.status }}</span>
                </div>
              </div>
              <ng-template #noImports>
                <div class="empty-state">
                  <mat-icon>cloud_upload</mat-icon>
                  <p>No recent imports</p>
                </div>
              </ng-template>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Reviewer Charts - Moved to Bottom -->
      <div *ngIf="isReviewer() && reviewerData">
        <h2 class="section-title">Analytics & Insights</h2>
        <div class="charts-row">
          <mat-card class="content-card chart-card">
            <mat-card-header>
              <mat-card-title>Entity-wise Compliance Health</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas baseChart
                  [type]="barChartType"
                  [data]="reviewerEntityChartData"
                  [options]="barChartOptions">
                </canvas>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="content-card chart-card">
            <mat-card-header>
              <mat-card-title>Department-wise Statistics</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas baseChart
                  [type]="barChartType"
                  [data]="reviewerDepartmentChartData"
                  [options]="barChartOptions">
                </canvas>
              </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Overdue Tasks List -->
      <mat-card class="content-card" *ngIf="isReviewer() && reviewerData.overdueTasks.length">
        <mat-card-header>
          <mat-card-title>Overdue Tasks Requiring Attention</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="overdue-list">
            <div class="overdue-item" *ngFor="let task of reviewerData.overdueTasks">
              <mat-icon class="overdue-icon">warning</mat-icon>
              <div class="overdue-info">
                <div class="overdue-title">{{ task.title }}</div>
                <div class="overdue-meta">
                  {{ task.entity?.name }} • {{ task.department?.name }} • Due: {{ task.dueDate | date:'short' }}
                </div>
              </div>
              <button mat-stroked-button [routerLink]="['/tasks', task.id]">View</button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
